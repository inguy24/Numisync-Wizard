<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NumiSync Wizard</title>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="app-header">
      <div class="header-brand">
        <img src="images/logo_with_text.svg" alt="NumiSync Wizard for OpenNumismat" class="app-logo">
        <div id="versionBadge" class="version-badge version-badge-free">Free Version</div>
      </div>

      <!-- Collection info (shown when collection is open) -->
      <div class="header-collection" id="headerCollection" style="display: none;">
        <h2 id="headerCollectionTitle" class="collection-title">Collection</h2>
      </div>

      <div class="header-actions">
        <!-- Collection-specific actions (shown when collection is open) -->
        <div class="collection-actions" id="headerCollectionActions" style="display: none;">
          <button id="fastPricingBtn" class="btn btn-secondary btn-premium btn-premium-locked">
            <span class="premium-icon">üîí</span> Fast Pricing Mode
          </button>
          <button id="closeCollectionBtn" class="btn btn-secondary">
            ‚Üê Close Collection
          </button>
        </div>

        <!-- Settings dropdown -->
        <div class="settings-dropdown" id="settingsDropdown">
          <button id="settingsDropdownBtn" class="btn btn-icon" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
          </button>
          <div class="settings-dropdown-menu" id="settingsDropdownMenu">
            <button id="settingsBtn" class="dropdown-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              App Settings
            </button>
            <button id="dataSettingsBtn" class="dropdown-item" style="display: none;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/>
              </svg>
              Data Settings
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      
      <!-- Screen 1: Welcome / Load Collection -->
      <div id="welcomeScreen" class="screen active">
        <div class="welcome-container">
          <img src="images/logo_with_text.svg" alt="NumiSync Wizard for OpenNumismat" class="welcome-logo">
          <p>Enrich your OpenNumismat collection with data from Numista</p>
          
          <div class="welcome-actions">
            <button id="loadCollectionBtn" class="btn btn-primary btn-large">
              üìÇ Load Collection
            </button>
          </div>

          <div class="welcome-info">
            <h3>Quick Start:</h3>
            <ol>
              <li><strong>First time?</strong> Click ‚öôÔ∏è Settings (top right) and add your Numista API key
                <br><small>Get a free key at <a href="https://en.numista.com/api/" target="_blank">numista.com/api</a></small>
              </li>
              <li><strong>Load your collection</strong> - Select your OpenNumismat .db file</li>
              <li><strong>Click on any coin</strong> to search Numista for matches</li>
              <li><strong>Select the best match</strong> from the results</li>
              <li><strong>Choose which fields to import</strong> and apply changes</li>
              <li><strong>Repeat</strong> for each coin you want to enrich</li>
            </ol>
            
            <p class="text-muted" style="margin-top: 20px;">
              üí° <strong>Tip:</strong> You work on one coin at a time to ensure accuracy. 
              Your progress is automatically saved!
            </p>
          </div>
        </div>
      </div>

      <!-- Screen 2: Collection Overview -->
      <div id="collectionScreen" class="screen">
        <!-- Info Bar Card (stats + filters) -->
        <div class="info-bar-card" id="infoBarCard">
          <!-- Dog-ear pin toggle -->
          <button class="info-bar-pin" id="infoBarPinBtn" title="Pin info bar">
            <svg class="pin-icon" viewBox="0 0 24 24" width="14" height="14">
              <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
            </svg>
          </button>

          <!-- Compact Stats Bar with Summary -->
          <div class="compact-stats-wrapper">
          <div class="compact-stats">
            <div class="compact-stat-item compact-stat-total">
              <span class="compact-stat-value" id="statTotal">0</span>
              <span class="compact-stat-label">COINS</span>
            </div>
            <div class="compact-stat-divider"></div>
            <div class="compact-stat-item" id="cardBasicData" title="Hover for details">
              <div class="compact-stat-header">
                <span class="compact-stat-name">Basic:</span>
                <span class="compact-stat-nums"><span id="statBasicMerged">0</span>/<span id="statBasicTotal">0</span></span>
              </div>
              <div class="compact-progress-bar"><div class="compact-progress-fill" id="barBasicData"></div></div>
            </div>
            <div class="compact-stat-divider"></div>
            <div class="compact-stat-item" id="cardIssueData" title="Hover for details">
              <div class="compact-stat-header">
                <span class="compact-stat-name">Issue:</span>
                <span class="compact-stat-nums"><span id="statIssueMerged">0</span>/<span id="statIssueTotal">0</span></span>
              </div>
              <div class="compact-progress-bar"><div class="compact-progress-fill" id="barIssueData"></div></div>
            </div>
            <div class="compact-stat-divider"></div>
            <div class="compact-stat-item" id="cardPricingData" title="Hover for details">
              <div class="compact-stat-header">
                <span class="compact-stat-name">Pricing:</span>
                <span class="compact-stat-nums"><span id="statPricingMerged">0</span>/<span id="statPricingTotal">0</span></span>
              </div>
              <div class="compact-progress-bar"><div class="compact-progress-fill" id="barPricingData"></div></div>
            </div>
          </div>
          <div class="stats-summary" id="statsSummaryRow">
            <div class="summary-line">
              <strong>Status:</strong>
              <span class="summary-count" id="countComplete">Complete: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countPartial">Partial: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countUnprocessed">Unprocessed: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countSkipped">Skipped: 0</span>
            </div>
            <div class="summary-line">
              <strong>Pricing:</strong>
              <span class="summary-count" id="countCurrent">Current: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countRecent">Recent: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countAging">Aging: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countOutdated">Outdated: 0</span>
              <span class="summary-sep">&middot;</span>
              <span class="summary-count" id="countNever">Never: 0</span>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <label>
            Show:
            <select id="statusFilter">
              <option value="all">All Coins</option>
              <option value="unprocessed">Unprocessed Only</option>
              <option value="merged">Merged (Basic Data)</option>
              <option value="skipped">Skipped</option>
              <optgroup label="Completeness">
                <option value="complete">Complete (All Data)</option>
                <option value="partial">Partial (Missing Some Data)</option>
              </optgroup>
              <optgroup label="Missing Data">
                <option value="missing_basic">Missing Basic Data</option>
                <option value="missing_issue">Missing Issue Data</option>
                <option value="missing_pricing">Missing Pricing Data</option>
              </optgroup>
            </select>
          </label>
          <label>
            Pricing Freshness:
            <select id="freshnessFilter">
              <option value="all">All Ages</option>
              <option value="current">Current (&lt; 3 months)</option>
              <option value="recent">Recent (3mo - 1yr)</option>
              <option value="aging">Aging (1-2 years)</option>
              <option value="outdated">Outdated (&gt; 2 years)</option>
              <option value="never">Never Updated</option>
            </select>
          </label>
          <label>
            Sort by:
            <select id="sortBy">
              <option value="title">Title</option>
              <option value="year">Year</option>
              <option value="country">Country</option>
              <option value="status">Status</option>
              <option value="last_update">Last Updated</option>
              <option value="pricing_freshness">Pricing Freshness</option>
            </select>
          </label>
          <button id="resetFiltersBtn" class="btn btn-small" title="Reset all filters to default">
            Reset Filters
          </button>
          <div class="view-toggle" id="viewToggle">
            <button id="listViewBtn" class="view-toggle-btn active" title="List View">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <rect x="0" y="1" width="16" height="3"/>
                <rect x="0" y="6" width="16" height="3"/>
                <rect x="0" y="11" width="16" height="3"/>
              </svg>
            </button>
            <button id="gridViewBtn" class="view-toggle-btn" title="Grid View">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <rect x="0" y="0" width="7" height="7"/>
                <rect x="9" y="0" width="7" height="7"/>
                <rect x="0" y="9" width="7" height="7"/>
                <rect x="9" y="9" width="7" height="7"/>
              </svg>
            </button>
          </div>
        </div>
        </div><!-- /info-bar-card -->

        <!-- Fast Pricing Mode Toolbar (hidden by default) -->
        <div id="fastPricingToolbar" class="fast-pricing-toolbar" style="display: none;">
          <div class="fast-pricing-info">
            <span class="fast-pricing-mode-indicator">Fast Pricing Mode</span>
            <span><span id="fpSelectedCount">0</span> selected</span>
            <span class="text-muted">(<span id="fpEligibleCount">0</span> eligible)</span>
          </div>
          <!-- Inline progress bar (visible during batch) -->
          <div id="fpInlineProgress" class="fp-inline-progress" style="display: none;">
            <div class="fp-progress-bar">
              <div id="fpProgressFill" class="fp-progress-fill"></div>
            </div>
            <span id="fpProgressText" class="fp-progress-text">0/0</span>
          </div>
          <div class="fast-pricing-actions">
            <button id="fpSelectAllEligible" class="btn btn-small">Select All Eligible</button>
            <button id="fpSelectDisplayed" class="btn btn-small">Select Displayed</button>
            <button id="fpSelectNone" class="btn btn-small">Clear</button>
            <button id="fpStartUpdate" class="btn btn-primary btn-small" disabled>
              Update (<span id="fpUpdateCount">0</span>)
            </button>
            <button id="fpCancelUpdate" class="btn btn-danger btn-small" style="display: none;">
              Cancel
            </button>
            <button id="fpExitMode" class="btn btn-secondary btn-small">Exit</button>
          </div>
        </div>

        <!-- Coin List -->
        <div class="coin-list" id="coinList">
          <!-- Coins will be dynamically added here -->
          <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
            <h3>üìã Click on any coin to get started</h3>
            <p>Select a coin from the list to search Numista and enrich its data.</p>
            <p style="margin-top: 20px;">
              üí° <strong>How it works:</strong><br>
              1. Click a coin ‚Üí 2. Review matches ‚Üí 3. Choose fields ‚Üí 4. Apply changes
            </p>
          </div>
        </div>
      </div>

      <!-- Screen 3: Match Selection -->
      <div id="matchScreen" class="screen">
        <div class="match-header">
          <h2>Select Matching Coin</h2>
          <div class="current-coin-info" id="currentCoinInfo">
            <!-- Current coin details shown here -->
          </div>
          <button id="backToListBtn" class="btn btn-secondary">
            ‚Üê Back to List
          </button>
        </div>

        <div class="match-controls">
          <div id="searchStatus" class="search-status">
            <p style="color: #666; margin: 10px 0;">
              üí° <strong>How to choose:</strong> Look for the highest confidence score and verify the details match your coin.
              Click on a match to see detailed field comparison.
            </p>
          </div>
          <button id="searchAgainBtn" class="btn btn-secondary">
            üîÑ Search Again
          </button>
          <button id="manualSearchBtn" class="btn btn-secondary">
            üîç Try Manual Search
          </button>
        </div>

        <div id="manualSearchPanel" class="manual-search-panel" style="display: none;">
          <h3>Manual Search</h3>
          <p class="help-text">
            Automatic search didn't work? Try searching with custom terms:
          </p>
          <div class="manual-search-form">
            <input
              type="text"
              id="manualSearchInput"
              placeholder="e.g., &quot;George V Penny&quot;, &quot;KM 23&quot;, &quot;1 Penny 1912&quot;"
              class="manual-search-input"
            >
            <select id="manualSearchCategory" class="manual-search-category">
              <option value="all">All</option>
              <option value="default">Default</option>
              <option value="coin">Coins</option>
              <option value="banknote">Banknotes</option>
              <option value="exonumia">Exonumia</option>
            </select>
            <button id="performManualSearchBtn" class="btn btn-primary">
              Search
            </button>
            <button id="cancelManualSearchBtn" class="btn btn-secondary">
              Cancel
            </button>
          </div>
          <div class="search-tips">
            <strong>Search Tips:</strong>
            <ul>
              <li>Try shorter terms: "1 Penny 1912" instead of full title</li>
              <li>Try denomination and year: "Penny 1912"</li>
              <li>Try ruler name: "George V"</li>
              <li>Try catalog number: "KM 23"</li>
              <li>Try country and year: "Australia 1912"</li>
            </ul>
          </div>
        </div>

        <div id="matchResults" class="match-results">
          <!-- Match results will be displayed here -->
        </div>

        <div class="match-actions">
          <button id="skipCoinBtn" class="btn btn-secondary">
            Skip This Coin
          </button>
        </div>
      </div>

      <!-- Screen 4: Field Comparison -->
      <div id="comparisonScreen" class="screen">
        <div class="comparison-header">
          <h2>Review and Select Fields</h2>
          <button id="backToMatchesBtn" class="btn btn-secondary">
            ‚Üê Back to Matches
          </button>
        </div>

        <div class="field-selection-controls">
          <p style="color: #666; margin-bottom: 10px;">
            üí° <strong>Select fields to import:</strong> Check the boxes for fields you want to update from Numista. 
            Fields in <strong>bold</strong> are different from your current data.
          </p>
          <button id="selectAllFieldsBtn" class="btn btn-small">Select All</button>
          <button id="selectNoneFieldsBtn" class="btn btn-small">Select None</button>
          <button id="selectEmptyFieldsBtn" class="btn btn-small">Select Empty Only</button>
          <button id="selectDifferentFieldsBtn" class="btn btn-small">Select Different Only</button>
        </div>

        <div id="fieldComparison" class="field-comparison">
          <!-- Field-by-field comparison will be displayed here -->
        </div>

        <div class="comparison-actions">
          <button id="applyChangesBtn" class="btn btn-primary btn-large">
            ‚úÖ Apply Changes to Coin
          </button>
          <button id="cancelMergeBtn" class="btn btn-secondary">
            Cancel
          </button>
        </div>
      </div>

      <!-- Screen 5: Settings -->
      <div id="settingsScreen" class="screen">
        <div class="settings-header">
          <h2>Settings</h2>
          <button id="closeSettingsBtn" class="btn btn-secondary">
            ‚Üê Close
          </button>
        </div>

        <div class="settings-content">
          <div class="setting-group">
            <h3>Numista API Key <span style="color: #e74c3c;">*Required</span></h3>
            <label>
              API Key:
              <input type="password" id="apiKeyInput" placeholder="Enter your Numista API key">
            </label>
            <p class="setting-help">
              <strong>Don't have an API key?</strong><br>
              1. Go to <a href="https://en.numista.com/" target="_blank">numista.com</a> and create a free account<br>
              2. Visit <a href="https://en.numista.com/api/" target="_blank">numista.com/api</a> to generate your key<br>
              3. Copy and paste it here<br>
              <br>
              The API key is <strong>free for personal use</strong> and lets you search the Numista database.
            </p>
          </div>

          <div class="setting-group">
            <h3>Search Settings</h3>
            <label>
              Request Delay (ms):
              <input type="number" id="requestDelayInput" value="2000" min="1000" max="10000" step="500">
            </label>
            <p class="setting-help">
              Time to wait between API requests. Default 2000ms (2 seconds) is recommended to respect Numista's servers.
            </p>
          </div>

          <div class="setting-group">
            <h3>Image Handling</h3>
            <label>
              <input type="radio" name="imageHandling" value="url" checked>
              Store image URLs (Recommended)
            </label>
            <label>
              <input type="radio" name="imageHandling" value="blob">
              Download and store images as BLOBs
            </label>
            <p class="setting-help">
              <strong>URL mode:</strong> OpenNumismat downloads images when you open the collection (requires internet)<br>
              <strong>BLOB mode:</strong> Images are downloaded now and stored in your database (works offline)
            </p>
          </div>

          <div class="setting-group">
            <h3>API Cache</h3>
            <p class="setting-help">
              Cache Numista API responses locally to reduce API calls against your monthly quota.
              Longer durations use fewer API calls but may show slightly stale data.
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; align-items: center;">
              <label for="cacheTtlIssuers">Issuers (countries):</label>
              <select id="cacheTtlIssuers">
                <option value="0">No caching</option>
                <option value="30">30 days</option>
                <option value="60">60 days</option>
                <option value="90" selected>90 days (recommended)</option>
                <option value="120">120 days</option>
                <option value="150">150 days</option>
                <option value="180">180 days</option>
                <option value="210">210 days</option>
                <option value="240">240 days</option>
                <option value="270">270 days</option>
                <option value="300">300 days</option>
                <option value="330">330 days</option>
                <option value="360">360 days</option>
              </select>
              <label for="cacheTtlTypes">Type data (coin specs):</label>
              <select id="cacheTtlTypes">
                <option value="0">No caching</option>
                <option value="30" selected>30 days (recommended)</option>
                <option value="60">60 days</option>
                <option value="90">90 days</option>
                <option value="120">120 days</option>
                <option value="150">150 days</option>
                <option value="180">180 days</option>
                <option value="210">210 days</option>
                <option value="240">240 days</option>
                <option value="270">270 days</option>
                <option value="300">300 days</option>
                <option value="330">330 days</option>
                <option value="360">360 days</option>
              </select>
              <label for="cacheTtlIssues">Issue data (mintage, mintmarks):</label>
              <select id="cacheTtlIssues">
                <option value="0">No caching</option>
                <option value="30" selected>30 days (recommended)</option>
                <option value="60">60 days</option>
                <option value="90">90 days</option>
                <option value="120">120 days</option>
                <option value="150">150 days</option>
                <option value="180">180 days</option>
                <option value="210">210 days</option>
                <option value="240">240 days</option>
                <option value="270">270 days</option>
                <option value="300">300 days</option>
                <option value="330">330 days</option>
                <option value="360">360 days</option>
              </select>
            </div>
            <div style="margin-top: 15px;">
              <label for="monthlyApiLimit">Monthly API call limit:</label>
              <input type="number" id="monthlyApiLimit" value="2000" min="100" max="100000" step="100" style="width: 100px; margin-left: 8px;">
              <p class="setting-help">
                Free Numista accounts have a 2,000 call/month limit. Change this if you have a premium API plan.
              </p>
            </div>
            <div style="margin-top: 10px;">
              <label for="currentMonthUsage">Current month usage:</label>
              <input type="number" id="currentMonthUsage" value="0" min="0" max="100000" step="1" style="width: 100px; margin-left: 8px;">
              <p class="setting-help">
                Usage is tracked locally and may not reflect API calls made by other applications using the same key.
                Visit the <a href="#" id="numistaDashboardLink">Numista API dashboard</a> to verify your actual usage and update this number if needed.
              </p>
            </div>
            <button id="clearApiCacheBtn" class="btn btn-secondary" style="margin-top: 10px;">
              Clear API Cache
            </button>
          </div>

          <div class="setting-group">
            <h3>Cache Location</h3>
            <p class="setting-help">
              Choose where to store the API cache. Use a custom location on a shared network drive if you use NumiSync Wizard on multiple computers.
            </p>

            <label style="display: block; margin-bottom: 8px;">
              <input type="radio" name="cacheLocation" value="default" checked>
              Default Location (Recommended)
            </label>
            <p class="setting-help" style="margin-left: 24px; margin-top: -4px; margin-bottom: 12px;">
              <span id="defaultCacheLocationPath" style="font-family: monospace; font-size: 0.9em;"></span>
            </p>

            <label style="display: block; margin-bottom: 8px;">
              <input type="radio" name="cacheLocation" value="custom">
              Custom Location (Advanced)
            </label>
            <div id="customCacheLocationControls" style="margin-left: 24px; display: none;">
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <input type="text" id="customCacheLocationInput" placeholder="Select cache directory..." style="flex: 1;" readonly>
                <button id="browseCacheLocationBtn" class="btn btn-secondary">Browse...</button>
              </div>
              <p class="setting-help">
                ‚ÑπÔ∏è <strong>Multi-Machine Setup:</strong> Select a folder on a network drive accessible from all computers.
              </p>
              <p class="setting-help" style="color: #d97706;">
                ‚ö†Ô∏è <strong>Requirements:</strong> The folder must be accessible with read/write permissions. Network shares and modern cloud sync services (Dropbox, OneDrive, etc.) work fine.
              </p>
            </div>

            <div style="margin-top: 15px;">
              <label for="cacheLockTimeout">Lock Timeout (seconds):</label>
              <input type="number" id="cacheLockTimeout" value="30" min="10" max="300" step="5" style="width: 80px; margin-left: 8px;">
              <p class="setting-help">
                How long to wait for cache file access before timing out. Increase if using a slow network connection.
              </p>
            </div>
          </div>

          <div class="setting-group">
            <h3>Logging</h3>
            <label for="logLevelSelect">Log detail level:</label>
            <select id="logLevelSelect">
              <option value="error">Error - Errors only</option>
              <option value="warn">Warning - Errors + warnings</option>
              <option value="info" selected>Info - Standard (recommended)</option>
              <option value="debug">Debug - Verbose (for troubleshooting)</option>
            </select>
            <p class="setting-help">
              Controls how much detail is written to the log file. Use <strong>Debug</strong> when
              troubleshooting an issue, then switch back to <strong>Info</strong> for normal use.
            </p>
            <button id="downloadLogBtn" class="btn btn-secondary" style="margin-top: 10px;">
              Download Log File
            </button>
            <p class="setting-help">
              Save a copy of the application log to share when reporting an issue.
            </p>
          </div>

          <div class="setting-group">
            <h3>Safety</h3>
            <label>
              <input type="checkbox" id="autoBackupCheckbox" checked>
              Automatically create backup before making changes
            </label>
            <p class="setting-help">
              <strong>Highly recommended!</strong> A timestamped backup is created in a "backups" folder next to your collection before any data is modified.
            </p>
            <p id="backupDisabledWarning" class="setting-help" style="display:none; color: #d9534f;">
              <strong>Warning:</strong> Disabling backups means data changes cannot be undone.
            </p>
            <div class="backup-limit-row" style="margin-top: 8px; display: flex; align-items: center; gap: 12px;">
              <label for="maxBackupsInput" style="white-space: nowrap;">Maximum backups to keep:</label>
              <input type="number" id="maxBackupsInput" min="0" value="5" style="width: 70px;">
              <label style="white-space: nowrap;">
                <input type="checkbox" id="unlimitedBackupsCheckbox">
                Unlimited
              </label>
            </div>
          </div>

          <div class="setting-group">
            <h3>Default Collection</h3>
            <p class="setting-help">
              Set a default collection to automatically load when the app starts. If not set, you will be prompted to select a collection each time.
            </p>
            <div class="default-collection-display" style="margin: 12px 0; padding: 10px; background: var(--bg-secondary, #f5f5f5); border-radius: 4px; display: flex; align-items: center; gap: 10px;">
              <span style="flex: 1; word-break: break-all;" id="defaultCollectionPath">
                <em>No default collection set</em>
              </span>
            </div>
            <div class="default-collection-actions" style="display: flex; gap: 10px;">
              <button id="browseDefaultCollectionBtn" class="btn btn-secondary">
                Browse...
              </button>
              <button id="useCurrentAsDefaultBtn" class="btn btn-secondary" style="display: none;">
                Use Current Collection
              </button>
              <button id="clearDefaultCollectionBtn" class="btn btn-secondary" style="display: none;">
                Clear Default
              </button>
            </div>
          </div>

          <div class="setting-group" id="licenseManagementGroup">
            <h3>License Management</h3>

            <!-- License entry form - shown when NO license -->
            <div id="licenseEntryForm" style="display: none;">
              <p class="setting-help">
                Enter your NumiSync Wizard license key to unlock premium features.
              </p>
              <div style="margin: 15px 0;">
                <label for="settingsLicenseKeyInput" style="display: block; margin-bottom: 5px;">License Key:</label>
                <input type="password"
                       id="settingsLicenseKeyInput"
                       placeholder="Enter your license key"
                       style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid var(--border-color, #ddd); border-radius: 4px;">
                <button id="settingsActivateLicenseBtn"
                        class="btn btn-primary"
                        style="margin-top: 10px;">
                  Activate License
                </button>
                <p id="settingsLicenseMessage" style="margin: 10px 0 0 0; font-size: 0.9em;"></p>
              </div>
              <p class="setting-help">
                Don't have a license? <a href="#" id="settingsPurchaseLicenseLink" style="color: var(--accent, #007bff);">Purchase one here</a>
              </p>
            </div>

            <!-- License info display - shown when license EXISTS -->
            <div id="licenseInfoDisplay" style="display: none;">
              <!-- License info will be populated by JavaScript -->
            </div>

            <!-- License actions - shown when license EXISTS -->
            <div id="licenseActions" style="margin-top: 15px; display: none;">
              <button id="revalidateLicenseBtn" class="btn btn-secondary" style="margin-right: 10px;">
                Validate License
              </button>
              <button id="deactivateLicenseBtn" class="btn btn-secondary" style="background-color: #dc3545; color: white;">
                Deactivate License
              </button>
            </div>

            <p class="setting-help" id="licenseActionsHelp" style="display: none;">
              <strong>Device Label:</strong> Identifies this installation on Polar's website.<br>
              <strong>Deactivate:</strong> Frees up one of your 3 device slots so you can activate on another device.
            </p>
          </div>

          <div class="setting-group">
            <h3>Legal</h3>
            <p><a href="#" id="viewEulaLink">View End User License Agreement</a></p>
          </div>

          <div class="settings-actions">
            <button id="saveSettingsBtn" class="btn btn-primary">
              Save Settings
            </button>
            <button id="resetSettingsBtn" class="btn btn-secondary">
              Reset to Defaults
            </button>
          </div>
        </div>
      </div>

    </main>

    <!-- Status Bar -->
    <footer class="app-footer">
      <div class="footer-left">
        <span id="statusMessage" class="status-message"></span>
      </div>
      <div class="footer-center">
        <div class="footer-pagination" id="footerPagination">
          <button id="firstPageBtn" class="pagination-btn" title="First Page">&#x23EE;</button>
          <button id="prevPageBtn" class="pagination-btn" title="Previous Page">&#x25C0;</button>
          <span id="pageInfo" class="pagination-info">Page 1 of 1</span>
          <button id="nextPageBtn" class="pagination-btn" title="Next Page">&#x25B6;</button>
          <button id="lastPageBtn" class="pagination-btn" title="Last Page">&#x23ED;</button>
        </div>
      </div>
      <div class="footer-right">
        <span id="fetchSettingsText">Fetch: Basic (2 calls)</span>
        <span class="separator">‚Ä¢</span>
        <span id="sessionCallsText">Session: 0 calls</span>
        <span class="separator">‚Ä¢</span>
        <span id="monthlyUsageText">Month: 0/2,000</span>
      </div>
      <div id="progressBar" class="footer-progress-bar" style="display: none;">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </footer>
  </div>

  <!-- Modal for dialogs -->
  <div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button id="modalClose" class="modal-close">√ó</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button id="modalOk" class="btn btn-primary">OK</button>
        <button id="modalCancel" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Data Settings Modal -->
  <div id="dataSettingsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚öôÔ∏è Data Settings</h3>
        <button id="dataSettingsCloseBtn" class="modal-close">√ó</button>
      </div>
      
      <div class="modal-body">
        <!-- Tab Bar -->
        <div class="tab-bar">
          <button class="tab-btn active" data-tab="fetchSettingsTab">Fetch Settings</button>
          <button class="tab-btn" data-tab="fieldMappingsTab">Field Mappings</button>
        </div>

        <!-- Fetch Settings Tab -->
        <div id="fetchSettingsTab" class="tab-panel active">
        <p class="help-text">
          Select which data to fetch for each coin. This helps you manage API usage and only get the data you need.
        </p>
        
        <div class="data-settings-options">
          
          <!-- Basic Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchBasicData" checked>
                <strong>Basic Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Core information about the coin:
              </p>
              <ul class="data-fields-list">
                <li>Title, country, denomination, year</li>
                <li>Composition, weight, diameter, shape</li>
                <li>Descriptions, catalog numbers</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> 2 API calls per coin
              </p>
            </div>
          </div>

          <!-- Issue Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchIssueData">
                <strong>Issue Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Mint-specific information:
              </p>
              <ul class="data-fields-list">
                <li>Mintmark (mint letter)</li>
                <li>Mintage (number minted)</li>
                <li>Auto-matched by year and mintmark when possible</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> +1 API call per coin
              </p>
              <p class="data-note">
                ‚ö†Ô∏è If multiple mints exist, you'll be asked to choose the correct one.
              </p>
            </div>
          </div>

          <!-- Pricing Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchPricingData">
                <strong>Pricing Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Current market values:
              </p>
              <ul class="data-fields-list">
                <li>Uncirculated (UNC) price</li>
                <li>Extremely Fine (XF) price</li>
                <li>Very Fine (VF) price</li>
                <li>Fine price</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> +1 API call per coin
              </p>
              <p class="data-note">
                ‚ö†Ô∏è Pricing includes freshness tracking (how recent the prices are).
              </p>
            </div>
          </div>

          <!-- Currency Selection -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <strong>Pricing Currency</strong>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Select your preferred currency for pricing data:
              </p>
              <div class="currency-select-wrapper">
                <select id="pricingCurrency" class="currency-select">
                  <option value="USD">USD - US Dollar</option>
                  <option value="EUR">EUR - Euro</option>
                  <option value="GBP">GBP - British Pound</option>
                  <option value="CAD">CAD - Canadian Dollar</option>
                  <option value="AUD">AUD - Australian Dollar</option>
                  <option value="JPY">JPY - Japanese Yen</option>
                  <option value="CHF">CHF - Swiss Franc</option>
                </select>
              </div>
              <p class="data-note">
                Note: Numista returns prices converted to your selected currency.
              </p>
            </div>
          </div>

          <!-- Search Category -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <strong>Search Category</strong>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Filter Numista search results by category:
              </p>
              <div class="currency-select-wrapper">
                <select id="searchCategory" class="currency-select">
                  <option value="all">All - Search everything</option>
                  <option value="default">Default - Use coin's category</option>
                  <option value="coin">Coins</option>
                  <option value="banknote">Banknotes</option>
                  <option value="exonumia">Exonumia (tokens, medals)</option>
                </select>
              </div>
              <p class="data-note">
                "Default" reads each coin's category from OpenNumismat. If blank or unmapped, searches all.
              </p>
            </div>
          </div>

          <!-- Empty Mintmark Interpretation (Task 3.12.7) -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <strong>Empty Mintmark Interpretation</strong>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                How should an empty/blank mintmark field be interpreted when matching issues?
              </p>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="emptyMintmark" id="emptyMintmarkNoMark" value="no_mint_mark" checked>
                  <span class="radio-text">
                    <strong>No mint mark</strong>
                    <span class="radio-description">Empty means no mint mark (e.g., Philadelphia before 1980). Matches issues with empty mint_letter.</span>
                  </span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="emptyMintmark" id="emptyMintmarkUnknown" value="unknown">
                  <span class="radio-text">
                    <strong>Unknown</strong>
                    <span class="radio-description">Empty means unknown. Let me choose the issue manually instead of auto-matching.</span>
                  </span>
                </label>
              </div>
              <p class="data-note">
                This affects both single coin enrichment and batch type propagation.
              </p>
            </div>
          </div>

          <!-- Auto-Propagate Toggle (Task 3.12.11) -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="enableAutoPropagate" checked>
                <strong>Auto-Propagate</strong>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                After enriching a coin, automatically detect other coins that share the same Numista type and offer to propagate data.
              </p>
              <ul class="data-fields-list">
                <li>Detects matching coins after merge completes</li>
                <li>Offers to apply type data to all matches at once</li>
                <li>Saves API calls by reusing fetched data</li>
              </ul>
              <p class="data-note">
                Applying data to multiple coins requires a premium license.
              </p>
            </div>
          </div>

        </div>

        <div class="data-settings-summary">
          <div class="summary-row">
            <span class="summary-label">Current Selection:</span>
            <span class="summary-value" id="callsPerCoinDisplay">2 calls per coin</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">This Session:</span>
            <span class="summary-value" id="sessionCallsDisplay">0 calls used</span>
          </div>
        </div>

        <div class="data-settings-info">
          <p>
            <strong>üí° Tip:</strong> You can change these settings at any time. For coins you've already processed, 
            use the "Fetch More Data" feature to add additional data types later.
          </p>
        </div>
      </div><!-- /fetchSettingsTab -->

        <!-- Field Mappings Tab -->
        <div id="fieldMappingsTab" class="tab-panel">
          <p class="help-text">
            Configure which Numista data source maps to each OpenNumismat field. You can enable/disable fields and change the source for each.
          </p>

          <!-- Filter Toolbar -->
          <div class="fm-toolbar">
            <div class="fm-toolbar-left">
              <label>Category:
                <select id="fmCategoryFilter" class="fm-filter-select">
                  <option value="all">All</option>
                </select>
              </label>
              <label>Status:
                <select id="fmStatusFilter" class="fm-filter-select">
                  <option value="all">All</option>
                  <option value="enabled">Enabled</option>
                  <option value="disabled">Disabled</option>
                </select>
              </label>
            </div>
            <div class="fm-toolbar-right">
              <button id="fmEnableAllBtn" class="btn btn-sm btn-secondary">Enable All Visible</button>
              <button id="fmDisableAllBtn" class="btn btn-sm btn-secondary">Disable All Visible</button>
            </div>
          </div>

          <!-- Field Mapping Table -->
          <div class="fm-table-container">
            <table class="fm-table">
              <thead>
                <tr>
                  <th class="fm-col-enabled">Enabled</th>
                  <th class="fm-col-field">OpenNumismat Field</th>
                  <th class="fm-col-source">Numista Source</th>
                  <th class="fm-col-catalog">Catalog Code</th>
                  <th class="fm-col-desc">Description</th>
                </tr>
              </thead>
              <tbody id="fmTableBody">
                <!-- Populated dynamically by JS -->
              </tbody>
            </table>
          </div>
        </div><!-- /fieldMappingsTab -->

      </div>
      
      <div class="modal-footer">
        <div class="modal-footer-left">
          <button id="exportFieldMappingsBtn" class="btn btn-sm btn-secondary" style="display:none;">Export</button>
          <button id="importFieldMappingsBtn" class="btn btn-sm btn-secondary" style="display:none;">Import</button>
        </div>
        <div class="modal-footer-right">
          <button id="saveDataSettingsBtn" class="btn btn-primary">Apply Settings</button>
          <button id="resetDataSettingsBtn" class="btn btn-secondary">Reset to Defaults</button>
          <button id="cancelDataSettingsBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Issue Picker Modal -->
  <div id="issuePickerModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Issue for <span id="issuePickerCoinName"></span></h3>
        <button id="issuePickerCloseBtn" class="modal-close">√ó</button>
      </div>

      <div class="modal-body">
        <div class="issue-picker-info">
          <p>Multiple issues were found for this coin. Please select which one matches your coin:</p>
          <div class="user-coin-info">
            <div class="user-coin-info-content">
              <div class="user-coin-images" id="issuePickerUserImages">
                <!-- User's coin images will be populated dynamically -->
              </div>
              <div class="user-coin-details">
                <strong>Your coin:</strong>
                <div>Year: <span id="issuePickerUserYear"></span></div>
                <div>Mintmark: <span id="issuePickerUserMintmark"></span></div>
                <div>Type: <span id="issuePickerUserType"></span></div>
              </div>
            </div>
          </div>
        </div>

        <div id="issueOptionsList" class="issue-options-list">
          <!-- Issue options will be populated dynamically -->
        </div>
      </div>

      <div class="modal-footer">
        <button id="applyIssueSelectionBtn" class="btn btn-primary" disabled>Apply Selection</button>
        <button id="skipIssueSelectionBtn" class="btn btn-secondary">Skip Issue Data</button>
      </div>
    </div>
  </div>

  <!-- Image Lightbox Modal -->
  <div id="imageLightbox" class="image-lightbox" style="display: none;">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
      <button class="lightbox-close" title="Close">&times;</button>
      <img id="lightboxImage" class="lightbox-image" src="" alt="Full size image">
      <div id="lightboxCaption" class="lightbox-caption"></div>
    </div>
  </div>

  <!-- EULA Modal -->
  <div id="eulaModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>End User License Agreement</h3>
      </div>

      <div class="modal-body eula-body">
        <div class="eula-scroll-container" id="eulaScrollContainer">
          <div id="eulaContent">
            <!-- EULA content populated by JavaScript -->
          </div>
        </div>

        <div class="eula-attribution">
          <p>This application uses data from <strong>Numista</strong> - the collaborative numismatic database.</p>
          <p><a href="#" id="eulaNumistaLink">Visit Numista</a></p>
        </div>
      </div>

      <div class="modal-footer eula-footer">
        <div class="eula-checkbox-row">
          <label>
            <input type="checkbox" id="eulaAcceptCheckbox">
            I have read and agree to the End User License Agreement
          </label>
        </div>
        <div class="eula-buttons">
          <button id="eulaAcceptBtn" class="btn btn-primary" disabled>I Accept</button>
          <button id="eulaDeclineBtn" class="btn btn-secondary">Decline and Exit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fast Pricing Completion Modal -->
  <div id="fpCompleteModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header"><h3>Update Complete</h3></div>
      <div class="modal-body">
        <!-- Content populated dynamically by showFpCompleteModal() -->
      </div>
      <div class="modal-footer">
        <button id="fpCompleteOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>


  <!-- Cache Collision Detection Modal -->
  <div id="cacheCollisionModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Existing Cache Detected</h3>
        <button id="cacheCollisionCloseBtn" class="modal-close">√ó</button>
      </div>
      <div class="modal-body">
        <div class="info-box">
          <p>An API cache already exists at the selected location:</p>
          <p style="font-family: monospace; margin-top: 10px;" id="collisionCachePath"></p>

          <div id="collisionCacheDetails" style="margin-top: 15px;">
            <!-- Populated by JS with cache metadata -->
          </div>
        </div>

        <div id="collisionLockWarning" class="warning-box" style="display: none; margin-top: 15px;">
          <strong>üîí Cache In Use</strong>
          <p id="lockWarningText"></p>
        </div>

        <p style="margin-top: 20px;">What would you like to do?</p>

        <div class="info-box" style="margin-top: 15px;">
          <strong>üí° Multi-Machine Tip:</strong> If you're setting up NumiSync Wizard on a second computer,
          choose "Use Existing Cache" to share cached API data between machines and save API quota.
        </div>
      </div>
      <div class="modal-footer" style="flex-direction: column; gap: 10px;">
        <button id="useExistingCacheBtn" class="btn btn-primary" style="width: 100%;">
          ‚úÖ Use Existing Cache (Recommended)
        </button>
        <button id="selectDifferentLocationBtn" class="btn btn-secondary" style="width: 100%;">
          üìÅ Select Different Location
        </button>
        <button id="cancelCollisionBtn" class="btn btn-secondary" style="width: 100%;">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Cache Locked Error Modal -->
  <div id="cacheLockedModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîí Cache Locked</h3>
        <button id="cacheLockedCloseBtn" class="modal-close">√ó</button>
      </div>
      <div class="modal-body">
        <div class="warning-box">
          <p>The selected cache location is currently in use by another NumiSync Wizard instance:</p>
          <div id="lockOwnerInfo" style="margin-top: 10px; font-family: monospace; font-size: 0.9em;">
            <!-- Populated with hostname, timestamp -->
          </div>
        </div>

        <p style="margin-top: 20px;">To use this cache location:</p>
        <ol style="text-align: left; margin-left: 20px;">
          <li>Close the other NumiSync Wizard instance</li>
          <li>Wait a few seconds for the lock to release</li>
          <li>Click "Retry" below</li>
        </ol>

        <p style="font-size: 0.9em; color: #666; margin-top: 15px;">
          Or select a different cache location to use a separate cache.
        </p>
      </div>
      <div class="modal-footer">
        <button id="retryLockedCacheBtn" class="btn btn-primary">üîÑ Retry</button>
        <button id="selectDifferentFromLockedBtn" class="btn btn-secondary">üìÅ Select Different Location</button>
        <button id="cancelLockedBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
