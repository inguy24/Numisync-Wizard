<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Numismat Enrichment Tool</title>
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="app-header">
      <h1>OpenNumismat - Numista Enrichment Tool</h1>
      <div class="header-actions">
        <button id="settingsBtn" class="btn btn-secondary">
          ‚öôÔ∏è Settings
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      
      <!-- Screen 1: Welcome / Load Collection -->
      <div id="welcomeScreen" class="screen active">
        <div class="welcome-container">
          <h2>Welcome to Numismat Enrichment</h2>
          <p>Enrich your OpenNumismat collection with data from Numista</p>
          
          <div class="welcome-actions">
            <button id="loadCollectionBtn" class="btn btn-primary btn-large">
              üìÇ Load Collection
            </button>
          </div>

          <div class="welcome-info">
            <h3>Quick Start:</h3>
            <ol>
              <li><strong>First time?</strong> Click ‚öôÔ∏è Settings (top right) and add your Numista API key
                <br><small>Get a free key at <a href="https://en.numista.com/api/" target="_blank">numista.com/api</a></small>
              </li>
              <li><strong>Load your collection</strong> - Select your OpenNumismat .db file</li>
              <li><strong>Click on any coin</strong> to search Numista for matches</li>
              <li><strong>Select the best match</strong> from the results</li>
              <li><strong>Choose which fields to import</strong> and apply changes</li>
              <li><strong>Repeat</strong> for each coin you want to enrich</li>
            </ol>
            
            <p class="text-muted" style="margin-top: 20px;">
              üí° <strong>Tip:</strong> You work on one coin at a time to ensure accuracy. 
              Your progress is automatically saved!
            </p>
          </div>
        </div>
      </div>

      <!-- Screen 2: Collection Overview -->
      <div id="collectionScreen" class="screen">
        <div class="collection-header">
          <h2 id="collectionTitle">Collection</h2>
          <div class="collection-actions">
            <button id="dataSettingsBtn" class="btn btn-secondary">
              ‚öôÔ∏è Data Settings
            </button>
            <button id="fastPricingBtn" class="btn btn-secondary">
              üí∞ Fast Pricing Update
            </button>
            <button id="closeCollectionBtn" class="btn btn-secondary">
              ‚Üê Close Collection
            </button>
          </div>
        </div>

        <!-- Progress Summary -->
        <div class="progress-summary">
          <div class="stat-card stat-card-total">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Coins</div>
          </div>
          <div class="stat-card data-type-card" id="cardBasicData">
            <div class="stat-label">Basic Data</div>
            <div class="stat-value data-type-value"><span id="statBasicMerged">0</span> <span class="stat-of">/ <span id="statBasicTotal">0</span></span></div>
            <div class="progress-bar"><div class="progress-bar-fill" id="barBasicData"></div></div>
            <div class="stat-secondary" id="secBasicData">
              <span class="stat-clickable stat-error-count" id="errBasicData" data-filter="missing_basic">0 errors</span>
              <span class="stat-sep">&middot;</span>
              <span class="stat-clickable stat-skip-count" id="skipBasicData" data-filter="skipped">0 skipped</span>
            </div>
          </div>
          <div class="stat-card data-type-card" id="cardIssueData">
            <div class="stat-label">Issue Data</div>
            <div class="stat-value data-type-value"><span id="statIssueMerged">0</span> <span class="stat-of">/ <span id="statIssueTotal">0</span></span></div>
            <div class="progress-bar"><div class="progress-bar-fill" id="barIssueData"></div></div>
            <div class="stat-secondary" id="secIssueData">
              <span class="stat-clickable stat-error-count" id="errIssueData" data-filter="missing_issue">0 errors</span>
              <span class="stat-sep">&middot;</span>
              <span class="stat-clickable stat-skip-count" id="skipIssueData" data-filter="skipped">0 skipped</span>
            </div>
          </div>
          <div class="stat-card data-type-card" id="cardPricingData">
            <div class="stat-label">Pricing Data</div>
            <div class="stat-value data-type-value"><span id="statPricingMerged">0</span> <span class="stat-of">/ <span id="statPricingTotal">0</span></span></div>
            <div class="progress-bar"><div class="progress-bar-fill" id="barPricingData"></div></div>
            <div class="stat-secondary" id="secPricingData">
              <span class="stat-clickable stat-error-count" id="errPricingData" data-filter="missing_pricing">0 errors</span>
              <span class="stat-sep">&middot;</span>
              <span class="stat-clickable stat-skip-count" id="skipPricingData" data-filter="skipped">0 skipped</span>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <label>
            Show:
            <select id="statusFilter">
              <option value="all">All Coins</option>
              <option value="unprocessed">Unprocessed Only</option>
              <option value="merged">Merged (Basic Data)</option>
              <option value="skipped">Skipped</option>
              <optgroup label="Completeness">
                <option value="complete">Complete (All Data)</option>
                <option value="partial">Partial (Missing Some Data)</option>
              </optgroup>
              <optgroup label="Missing Data">
                <option value="missing_basic">Missing Basic Data</option>
                <option value="missing_issue">Missing Issue Data</option>
                <option value="missing_pricing">Missing Pricing Data</option>
              </optgroup>
            </select>
          </label>
          <label>
            Pricing Freshness:
            <select id="freshnessFilter">
              <option value="all">All Ages</option>
              <option value="current">Current (&lt; 3 months)</option>
              <option value="recent">Recent (3mo - 1yr)</option>
              <option value="aging">Aging (1-2 years)</option>
              <option value="outdated">Outdated (&gt; 2 years)</option>
              <option value="never">Never Updated</option>
            </select>
          </label>
          <label>
            Sort by:
            <select id="sortBy">
              <option value="title">Title</option>
              <option value="year">Year</option>
              <option value="country">Country</option>
              <option value="status">Status</option>
              <option value="last_update">Last Updated</option>
              <option value="pricing_freshness">Pricing Freshness</option>
            </select>
          </label>
          <button id="resetFiltersBtn" class="btn btn-small" title="Reset all filters to default">
            Reset Filters
          </button>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary" id="filterSummary" style="display: none;">
          <!-- Filter counts will be populated here -->
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
          <button id="firstPageBtn" class="pagination-btn" title="First Page">
            <span>‚èÆÔ∏è</span>
          </button>
          <button id="prevPageBtn" class="pagination-btn" title="Previous Page">
            <span>‚óÄÔ∏è</span>
          </button>
          <div class="pagination-info">
            <span id="pageInfo">Page 1 of 1</span>
          </div>
          <button id="nextPageBtn" class="pagination-btn" title="Next Page">
            <span>‚ñ∂Ô∏è</span>
          </button>
          <button id="lastPageBtn" class="pagination-btn" title="Last Page">
            <span>‚è≠Ô∏è</span>
          </button>
        </div>

        <!-- Coin List -->
        <div class="coin-list" id="coinList">
          <!-- Coins will be dynamically added here -->
          <div class="empty-state" style="text-align: center; padding: 40px; color: #666;">
            <h3>üìã Click on any coin to get started</h3>
            <p>Select a coin from the list to search Numista and enrich its data.</p>
            <p style="margin-top: 20px;">
              üí° <strong>How it works:</strong><br>
              1. Click a coin ‚Üí 2. Review matches ‚Üí 3. Choose fields ‚Üí 4. Apply changes
            </p>
          </div>
        </div>
      </div>

      <!-- Screen 3: Match Selection -->
      <div id="matchScreen" class="screen">
        <div class="match-header">
          <h2>Select Matching Coin</h2>
          <div class="current-coin-info" id="currentCoinInfo">
            <!-- Current coin details shown here -->
          </div>
          <button id="backToListBtn" class="btn btn-secondary">
            ‚Üê Back to List
          </button>
        </div>

        <div class="match-controls">
          <div id="searchStatus" class="search-status">
            <p style="color: #666; margin: 10px 0;">
              üí° <strong>How to choose:</strong> Look for the highest confidence score and verify the details match your coin.
              Click on a match to see detailed field comparison.
            </p>
          </div>
          <button id="searchAgainBtn" class="btn btn-secondary">
            üîÑ Search Again
          </button>
          <button id="manualSearchBtn" class="btn btn-secondary">
            üîç Try Manual Search
          </button>
        </div>

        <div id="manualSearchPanel" class="manual-search-panel" style="display: none;">
          <h3>Manual Search</h3>
          <p class="help-text">
            Automatic search didn't work? Try searching with custom terms:
          </p>
          <div class="manual-search-form">
            <input
              type="text"
              id="manualSearchInput"
              placeholder="e.g., &quot;George V Penny&quot;, &quot;KM 23&quot;, &quot;1 Penny 1912&quot;"
              class="manual-search-input"
            >
            <select id="manualSearchCategory" class="manual-search-category">
              <option value="all">All</option>
              <option value="default">Default</option>
              <option value="coin">Coins</option>
              <option value="banknote">Banknotes</option>
              <option value="exonumia">Exonumia</option>
            </select>
            <button id="performManualSearchBtn" class="btn btn-primary">
              Search
            </button>
            <button id="cancelManualSearchBtn" class="btn btn-secondary">
              Cancel
            </button>
          </div>
          <div class="search-tips">
            <strong>Search Tips:</strong>
            <ul>
              <li>Try shorter terms: "1 Penny 1912" instead of full title</li>
              <li>Try denomination and year: "Penny 1912"</li>
              <li>Try ruler name: "George V"</li>
              <li>Try catalog number: "KM 23"</li>
              <li>Try country and year: "Australia 1912"</li>
            </ul>
          </div>
        </div>

        <div id="matchResults" class="match-results">
          <!-- Match results will be displayed here -->
        </div>

        <div class="match-actions">
          <button id="skipCoinBtn" class="btn btn-secondary">
            Skip This Coin
          </button>
        </div>
      </div>

      <!-- Screen 4: Field Comparison -->
      <div id="comparisonScreen" class="screen">
        <div class="comparison-header">
          <h2>Review and Select Fields</h2>
          <button id="backToMatchesBtn" class="btn btn-secondary">
            ‚Üê Back to Matches
          </button>
        </div>

        <div class="field-selection-controls">
          <p style="color: #666; margin-bottom: 10px;">
            üí° <strong>Select fields to import:</strong> Check the boxes for fields you want to update from Numista. 
            Fields in <strong>bold</strong> are different from your current data.
          </p>
          <button id="selectAllFieldsBtn" class="btn btn-small">Select All</button>
          <button id="selectNoneFieldsBtn" class="btn btn-small">Select None</button>
          <button id="selectEmptyFieldsBtn" class="btn btn-small">Select Empty Only</button>
          <button id="selectDifferentFieldsBtn" class="btn btn-small">Select Different Only</button>
        </div>

        <div id="fieldComparison" class="field-comparison">
          <!-- Field-by-field comparison will be displayed here -->
        </div>

        <div class="comparison-actions">
          <button id="applyChangesBtn" class="btn btn-primary btn-large">
            ‚úÖ Apply Changes to Coin
          </button>
          <button id="cancelMergeBtn" class="btn btn-secondary">
            Cancel
          </button>
        </div>
      </div>

      <!-- Screen 5: Settings -->
      <div id="settingsScreen" class="screen">
        <div class="settings-header">
          <h2>Settings</h2>
          <button id="closeSettingsBtn" class="btn btn-secondary">
            ‚Üê Close
          </button>
        </div>

        <div class="settings-content">
          <div class="setting-group">
            <h3>Numista API Key <span style="color: #e74c3c;">*Required</span></h3>
            <label>
              API Key:
              <input type="password" id="apiKeyInput" placeholder="Enter your Numista API key">
            </label>
            <p class="setting-help">
              <strong>Don't have an API key?</strong><br>
              1. Go to <a href="https://en.numista.com/" target="_blank">numista.com</a> and create a free account<br>
              2. Visit <a href="https://en.numista.com/api/" target="_blank">numista.com/api</a> to generate your key<br>
              3. Copy and paste it here<br>
              <br>
              The API key is <strong>free for personal use</strong> and lets you search the Numista database.
            </p>
          </div>

          <div class="setting-group">
            <h3>Search Settings</h3>
            <label>
              Request Delay (ms):
              <input type="number" id="requestDelayInput" value="2000" min="1000" max="10000" step="500">
            </label>
            <p class="setting-help">
              Time to wait between API requests. Default 2000ms (2 seconds) is recommended to respect Numista's servers.
            </p>
          </div>

          <div class="setting-group">
            <h3>Image Handling</h3>
            <label>
              <input type="radio" name="imageHandling" value="url" checked>
              Store image URLs (Recommended)
            </label>
            <label>
              <input type="radio" name="imageHandling" value="blob">
              Download and store images as BLOBs
            </label>
            <p class="setting-help">
              <strong>URL mode:</strong> OpenNumismat downloads images when you open the collection (requires internet)<br>
              <strong>BLOB mode:</strong> Images are downloaded now and stored in your database (works offline)
            </p>
          </div>

          <div class="setting-group">
            <h3>Safety</h3>
            <label>
              <input type="checkbox" id="autoBackupCheckbox" checked>
              Automatically create backup before making changes
            </label>
            <p class="setting-help">
              <strong>Highly recommended!</strong> A timestamped backup is created in a "backups" folder next to your collection before any data is modified.
            </p>
            <p id="backupDisabledWarning" class="setting-help" style="display:none; color: #d9534f;">
              <strong>Warning:</strong> Disabling backups means data changes cannot be undone.
            </p>
            <div class="backup-limit-row" style="margin-top: 8px; display: flex; align-items: center; gap: 12px;">
              <label for="maxBackupsInput" style="white-space: nowrap;">Maximum backups to keep:</label>
              <input type="number" id="maxBackupsInput" min="0" value="5" style="width: 70px;">
              <label style="white-space: nowrap;">
                <input type="checkbox" id="unlimitedBackupsCheckbox">
                Unlimited
              </label>
            </div>
          </div>

          <div class="settings-actions">
            <button id="saveSettingsBtn" class="btn btn-primary">
              Save Settings
            </button>
            <button id="resetSettingsBtn" class="btn btn-secondary">
              Reset to Defaults
            </button>
          </div>
        </div>
      </div>

    </main>

    <!-- Status Bar -->
    <footer class="app-footer">
      <div id="statusMessage" class="status-message"></div>
      <div class="fetch-settings-display">
        <span id="fetchSettingsText">Fetch: Basic (2 calls)</span>
        <span class="separator">‚Ä¢</span>
        <span id="sessionCallsText">Session: 0 calls</span>
      </div>
      <div id="progressBar" class="progress-bar" style="display: none;">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </footer>
  </div>

  <!-- Modal for dialogs -->
  <div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button id="modalClose" class="modal-close">√ó</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button id="modalOk" class="btn btn-primary">OK</button>
        <button id="modalCancel" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Data Settings Modal -->
  <div id="dataSettingsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚öôÔ∏è Data Fetch Settings</h3>
        <button id="dataSettingsCloseBtn" class="modal-close">√ó</button>
      </div>
      
      <div class="modal-body">
        <p class="help-text">
          Select which data to fetch for each coin. This helps you manage API usage and only get the data you need.
        </p>
        
        <div class="data-settings-options">
          
          <!-- Basic Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchBasicData" checked>
                <strong>Basic Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Core information about the coin:
              </p>
              <ul class="data-fields-list">
                <li>Title, country, denomination, year</li>
                <li>Composition, weight, diameter, shape</li>
                <li>Descriptions, catalog numbers</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> 2 API calls per coin
              </p>
            </div>
          </div>

          <!-- Issue Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchIssueData">
                <strong>Issue Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Mint-specific information:
              </p>
              <ul class="data-fields-list">
                <li>Mintmark (mint letter)</li>
                <li>Mintage (number minted)</li>
                <li>Auto-matched by year and mintmark when possible</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> +1 API call per coin
              </p>
              <p class="data-note">
                ‚ö†Ô∏è If multiple mints exist, you'll be asked to choose the correct one.
              </p>
            </div>
          </div>

          <!-- Pricing Data -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <label class="checkbox-label">
                <input type="checkbox" id="fetchPricingData">
                <strong>Pricing Data</strong> <span class="optional-badge">OPTIONAL</span>
              </label>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Current market values:
              </p>
              <ul class="data-fields-list">
                <li>Uncirculated (UNC) price</li>
                <li>Extremely Fine (XF) price</li>
                <li>Very Fine (VF) price</li>
                <li>Fine price</li>
              </ul>
              <p class="api-cost">
                <strong>Cost:</strong> +1 API call per coin
              </p>
              <p class="data-note">
                ‚ö†Ô∏è Pricing includes freshness tracking (how recent the prices are).
              </p>
            </div>
          </div>

          <!-- Currency Selection -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <strong>Pricing Currency</strong>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Select your preferred currency for pricing data:
              </p>
              <div class="currency-select-wrapper">
                <select id="pricingCurrency" class="currency-select">
                  <option value="USD">USD - US Dollar</option>
                  <option value="EUR">EUR - Euro</option>
                  <option value="GBP">GBP - British Pound</option>
                  <option value="CAD">CAD - Canadian Dollar</option>
                  <option value="AUD">AUD - Australian Dollar</option>
                  <option value="JPY">JPY - Japanese Yen</option>
                  <option value="CHF">CHF - Swiss Franc</option>
                </select>
              </div>
              <p class="data-note">
                Note: Numista returns prices converted to your selected currency.
              </p>
            </div>
          </div>

          <!-- Search Category -->
          <div class="data-setting-card">
            <div class="data-setting-header">
              <strong>Search Category</strong>
            </div>
            <div class="data-setting-details">
              <p class="data-description">
                Filter Numista search results by category:
              </p>
              <div class="currency-select-wrapper">
                <select id="searchCategory" class="currency-select">
                  <option value="all">All - Search everything</option>
                  <option value="default">Default - Use coin's category</option>
                  <option value="coin">Coins</option>
                  <option value="banknote">Banknotes</option>
                  <option value="exonumia">Exonumia (tokens, medals)</option>
                </select>
              </div>
              <p class="data-note">
                "Default" reads each coin's category from OpenNumismat. If blank or unmapped, searches all.
              </p>
            </div>
          </div>

        </div>

        <div class="data-settings-summary">
          <div class="summary-row">
            <span class="summary-label">Current Selection:</span>
            <span class="summary-value" id="callsPerCoinDisplay">2 calls per coin</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">This Session:</span>
            <span class="summary-value" id="sessionCallsDisplay">0 calls used</span>
          </div>
        </div>

        <div class="data-settings-info">
          <p>
            <strong>üí° Tip:</strong> You can change these settings at any time. For coins you've already processed, 
            use the "Fetch More Data" feature to add additional data types later.
          </p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button id="saveDataSettingsBtn" class="btn btn-primary">Apply Settings</button>
        <button id="resetDataSettingsBtn" class="btn btn-secondary">Reset to Defaults</button>
        <button id="cancelDataSettingsBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Issue Picker Modal -->
  <div id="issuePickerModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Issue for <span id="issuePickerCoinName"></span></h3>
        <button id="issuePickerCloseBtn" class="modal-close">√ó</button>
      </div>

      <div class="modal-body">
        <div class="issue-picker-info">
          <p>Multiple issues were found for this coin. Please select which one matches your coin:</p>
          <div class="user-coin-info">
            <div class="user-coin-info-content">
              <div class="user-coin-images" id="issuePickerUserImages">
                <!-- User's coin images will be populated dynamically -->
              </div>
              <div class="user-coin-details">
                <strong>Your coin:</strong>
                <div>Year: <span id="issuePickerUserYear"></span></div>
                <div>Mintmark: <span id="issuePickerUserMintmark"></span></div>
                <div>Type: <span id="issuePickerUserType"></span></div>
              </div>
            </div>
          </div>
        </div>

        <div id="issueOptionsList" class="issue-options-list">
          <!-- Issue options will be populated dynamically -->
        </div>
      </div>

      <div class="modal-footer">
        <button id="applyIssueSelectionBtn" class="btn btn-primary" disabled>Apply Selection</button>
        <button id="skipIssueSelectionBtn" class="btn btn-secondary">Skip Issue Data</button>
      </div>
    </div>
  </div>

  <!-- Image Lightbox Modal -->
  <div id="imageLightbox" class="image-lightbox" style="display: none;">
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
      <button class="lightbox-close" title="Close">&times;</button>
      <img id="lightboxImage" class="lightbox-image" src="" alt="Full size image">
      <div id="lightboxCaption" class="lightbox-caption"></div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
